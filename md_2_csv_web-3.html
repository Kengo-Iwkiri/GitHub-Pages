<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Markdown → CSV 変換ツール（明るいテーマ / テーブル or 入り子ビュー）</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--muted:#64748b;--fg:#0f172a;--accent:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    header{padding:24px 16px;border-bottom:1px solid #e2e8f0;background:linear-gradient(90deg,#e0f2fe,#ffffff);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
    h1 .logo{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#3b82f6,#60a5fa);color:#fff}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;padding:14px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .drop{border:2px dashed #cbd5e1;border-radius:12px;padding:14px;text-align:center;background:#f1f5f9;transition:.2s}
    .drop.dragover{border-color:var(--accent);background:#e0f2fe}
    .muted{color:var(--muted);font-size:12px}
    input[type="file"]{display:none}
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;font-size:12px}
    .btn-ghost{background:#f1f5f9;border:1px solid #cbd5e1;color:#1e293b}
    .btn-primary{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff}
    .btn-tab{background:#eef2ff;border:1px solid #c7d2fe;color:#1e3a8a}
    .btn.active{outline:2px solid #93c5fd}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    textarea{width:100%;background:#ffffff;border:1px solid #cbd5e1;color:#0f172a;border-radius:10px;padding:8px;resize:vertical;font-size:12px}

    /* --- テーブルビュー（Notion風横スクロール） --- */
    .tablewrap{border:1px solid #e2e8f0;border-radius:10px;max-height:420px;overflow:auto}
    table{border-collapse:collapse;width:max-content;min-width:100%;font-size:13px}
    th,td{border-bottom:1px solid #e2e8f0;padding:8px 10px;text-align:left;vertical-align:top;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    th{background:#eaf3ff;position:sticky;top:0;z-index:3}
    th:first-child, td:first-child{position:sticky;left:0;background:#fff;z-index:2}
    th:first-child{background:#eaf3ff;z-index:4}
    tr:nth-child(even) td{background:#f8fafc}

    /* --- 入り子（アコーディオン）ビュー --- */
    .list{display:grid;gap:8px}
    details.item{border:1px solid #e2e8f0;border-radius:10px;background:#ffffff}
    summary{display:flex;align-items:center;gap:8px;padding:8px 12px;list-style:none;cursor:pointer}
    summary::-webkit-details-marker{display:none}
    .badge{font-size:11px;background:#eaf3ff;border:1px solid #cfe3ff;color:#1e3a8a;border-radius:999px;padding:2px 8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:6px 12px;padding:0 12px 12px}
    .kv .k{color:#475569}
    .kv .v{white-space:pre-wrap;word-break:break-word}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap}
    .toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label.switch{display:inline-flex;align-items:center;gap:6px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1><span class="logo">🗂</span> Markdown → CSV 変換（テーブル / 入り子）</h1>
  </header>
  <main>
    <div class="grid">
      <section class="card">
        <h2>1) ファイル投入</h2>
        <div id="drop" class="drop">
          <p>ここに <b>.md</b> をドラッグ＆ドロップ</p>
          <p class="muted">複数ファイルOK・端末内で完結（サーバー送信なし）</p>
          <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
            <label class="btn btn-ghost" for="file">ファイル選択…</label>
            <input id="file" type="file" accept=".md" multiple />
            <button id="convertBtn" class="btn btn-primary" disabled>変換＆プレビュー</button>
          </div>
          <div class="muted" style="text-align:center;margin-top:6px">※ ファイル名は「#」列に入ります</div>
        </div>
      </section>
      <section class="card">
        <h2>2) 固定キー（カラム順）</h2>
        <textarea id="keys" rows="14"></textarea>
      </section>
    </div>

    <section class="card">
      <div class="toolbar">
        <div class="left">
          <strong>3) 出力</strong>
          <div class="btn-group" role="tablist">
            <button id="tabTable" class="btn btn-tab active" type="button">テーブル</button>
            <button id="tabNested" class="btn btn-tab" type="button">入り子</button>
          </div>
        </div>
        <div class="right">
          <label class="switch"><input id="useMap" type="checkbox" checked> 座標をGoogleマップURLに変換</label>
          <button id="downloadBtn" class="btn btn-primary" disabled>CSVダウンロード</button>
        </div>
      </div>
      <div id="viewTable" class="tablewrap" hidden></div>
      <div id="viewNested" class="list" hidden></div>
    </section>
  </main>

  <script>
    const DEFAULT_KEYS=[
      "ガイドライン","今後の企画に盛り込みたいテーマやイベント","企業ロゴ","動画出演が可能な社員やスタッフの名前と役職","回答者","投稿内容の承認フロー","提出日時","撮影可能な日程の候補","撮影可能な日程の候補 (1)","撮影可能な日程の候補 (2)","撮影可能な日程の候補 (3)","撮影可能な日程の候補 (4)","撮影可能な日程の候補 (5)","撮影可能な社内スペース・現場場所の候補","社内での肖像権や情報発信ルールの有無","競合アカウント","説明","過去に使用した写真","過去の採用広報資料や記事"
    ];
    document.getElementById('keys').value=DEFAULT_KEYS.join('\n');

    const drop=document.getElementById('drop');
    const fileInput=document.getElementById('file');
    const convertBtn=document.getElementById('convertBtn');
    const useMapCk=document.getElementById('useMap');
    const viewTable=document.getElementById('viewTable');
    const viewNested=document.getElementById('viewNested');
    const tabTable=document.getElementById('tabTable');
    const tabNested=document.getElementById('tabNested');
    const downloadBtn=document.getElementById('downloadBtn');

    let files=[]; let lastCsvBlob=null; let lastParsedList=null; let lastKeys=null;

    drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('dragover')});
    drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
    drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('dragover');const mdFiles=Array.from(e.dataTransfer.files||[]).filter(f=>f.name.toLowerCase().endsWith('.md'));if(mdFiles.length===0){alert('*.md ファイルを選択してください');return;}files=mdFiles;convertBtn.disabled=false;drop.querySelector('p').innerText=`${files.length} 件の .md を読み込みました`;});
    fileInput.addEventListener('change',e=>{const mdFiles=Array.from(e.target.files||[]).filter(f=>f.name.toLowerCase().endsWith('.md'));if(mdFiles.length===0){alert('*.md ファイルを選択してください');return;}files=mdFiles;convertBtn.disabled=false;drop.querySelector('p').innerText=`${files.length} 件の .md を読み込みました`;});

    const kvPattern=/^(?<key>[^:：]+?)\s*[:：]\s*(?<val>.*)$/;
    function parseMd(text){const data={};for(const raw of text.split(/\r?\n/)){const line=raw.trim();if(!line||line.startsWith('#'))continue;const m=line.match(kvPattern);if(!m)continue;data[m.groups.key.trim()]=m.groups.val.trim()}return data}

    function csvEscape(s){const str=(s??'').toString();if(/[",\n]/.test(str))return '"'+str.replace(/"/g,'""')+'"';return str}

    const coordRe=/^\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*$/;
    function coordToMaps(val){const m=(val||'').match(coordRe);if(!m)return null;const lat=Number(m[1]).toFixed(5);const lon=Number(m[2]).toFixed(5);return `https://www.google.com/maps/place/${lat},${lon}`}

    function buildTable(parsedList,expectedKeys,useMapLinks){
      const table=document.createElement('table');
      const thead=document.createElement('thead');
      const tbody=document.createElement('tbody');
      const trh=document.createElement('tr');
      ['#',...expectedKeys].forEach(h=>{const th=document.createElement('th');th.textContent=h;trh.appendChild(th)});
      thead.appendChild(trh);
      parsedList.forEach(({name,parsed})=>{
        const tr=document.createElement('tr');
        const td0=document.createElement('td'); td0.textContent=name; tr.appendChild(td0);
        expectedKeys.forEach(k=>{let v=parsed[k]??''; if(useMapLinks){const url=coordToMaps(v); if(url) v=url;} const td=document.createElement('td'); td.textContent=v; td.title=v; tr.appendChild(td)});
        tbody.appendChild(tr);
      });
      table.appendChild(thead); table.appendChild(tbody);
      return table;
    }

    function buildNested(parsedList,expectedKeys,useMapLinks){
      const frag=document.createDocumentFragment();
      parsedList.forEach(({name,parsed})=>{
        const det=document.createElement('details'); det.className='item';
        const sum=document.createElement('summary');
        const nameEl=document.createElement('span'); nameEl.className='mono'; nameEl.textContent=name; sum.appendChild(nameEl);
        // 先頭3項目をバッジで要約
        expectedKeys.slice(0,3).forEach(k=>{const v=parsed[k]; if(!v) return; const b=document.createElement('span'); b.className='badge'; b.title=v; b.textContent=(v+"").slice(0,18)+(v.length>18?'…':''); sum.appendChild(b)});
        det.appendChild(sum);
        const kv=document.createElement('div'); kv.className='kv';
        // # 行
        const k0=document.createElement('div'); k0.className='k'; k0.textContent='#';
        const v0=document.createElement('div'); v0.className='v mono'; v0.textContent=name; kv.appendChild(k0); kv.appendChild(v0);
        expectedKeys.forEach(k=>{const dk=document.createElement('div'); dk.className='k'; dk.textContent=k; const dv=document.createElement('div'); dv.className='v'; let val=parsed[k]??''; if(useMapLinks){const url=coordToMaps(val); if(url){ const a=document.createElement('a'); a.href=url; a.textContent=url; a.target='_blank'; a.rel='noopener'; dv.appendChild(a); kv.appendChild(dk); kv.appendChild(dv); return; }} dv.textContent=val; kv.appendChild(dk); kv.appendChild(dv);});
        det.appendChild(kv);
        frag.appendChild(det);
      });
      return frag;
    }

    function toCsvBlob(parsedList,expectedKeys,useMapLinks){
      const headers=['#',...expectedKeys];
      const lines=[headers.join(',')];
      for(const {name,parsed} of parsedList){
        const row=[csvEscape(name)];
        for(const k of expectedKeys){let v=parsed[k]??''; if(useMapLinks){const u=coordToMaps(v); if(u) v=u;} row.push(csvEscape(v));}
        lines.push(row.join(','));
      }
      const bom=new Uint8Array([0xEF,0xBB,0xBF]);
      return new Blob([bom,lines.join('\n')],{type:'text/csv;charset=utf-8;'});
    }

    async function render(){
      if(files.length===0) return;
      viewTable.innerHTML=''; viewNested.innerHTML=''; downloadBtn.disabled=true; lastCsvBlob=null;
      const expected=document.getElementById('keys').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const useMapLinks=useMapCk.checked;
      const parsedList=[];
      for(const f of files){const text=await f.text(); parsedList.push({name:f.name.replace(/\.md$/i,''), parsed:parseMd(text)});}
      lastParsedList=parsedList; lastKeys=expected;
      // 初期は「入り子」優先表示
      setActiveTab('nested');
      const table=buildTable(parsedList,expected,useMapLinks);
      viewTable.appendChild(table);
      const nested=buildNested(parsedList,expected,useMapLinks);
      viewNested.appendChild(nested);
      lastCsvBlob=toCsvBlob(parsedList,expected,useMapLinks);
      downloadBtn.disabled=false;
    }

    function setActiveTab(which){
      const isTable=(which==='table');
      tabTable.classList.toggle('active', isTable);
      tabNested.classList.toggle('active', !isTable);
      viewTable.hidden=!isTable;
      viewNested.hidden=isTable;
    }

    convertBtn.addEventListener('click',render);
    tabTable.addEventListener('click',()=>setActiveTab('table'));
    tabNested.addEventListener('click',()=>setActiveTab('nested'));

    downloadBtn.addEventListener('click',()=>{
      if(!lastCsvBlob) return; const url=URL.createObjectURL(lastCsvBlob); const a=document.createElement('a'); a.href=url; a.download='merged_output.csv'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),800);
    });
  </script>
</body>
</html>